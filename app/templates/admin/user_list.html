{% extends "visualisation/base.html" %}
{% block content %}
<div class="container py-4">
  <h3 class="mb-4 fw-bold text-primary">User Management</h3>

  <form id="bulk-delete-form" class="mb-3">
    <button type="button" class="btn btn-danger" id="trigger-delete">Delete Selected</button>
  </form>

  <div class="card shadow-sm">
    <div class="card-body">
      <table id="user-table" class="table table-striped table-bordered w-100 align-middle">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>Email</th>
            <th>Role</th>
            <th>Temp Password</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr {% if user.is_main_admin %}class="table-primary fw-bold"{% endif %}>
            <td>
              {% if not user.is_main_admin and (user.role != 'admin' or session['is_main_admin']) %}
                <input type="checkbox" class="select-user" value="{{ user.email }}||{{ user.role }}">
              {% endif %}
            </td>
            <td>{{ user.email }}</td>
            <td>
              {{ user.role }}
              {% if user.is_main_admin %}
                <span class="badge bg-warning text-dark ms-2">Main Admin</span>
              {% endif %}
            </td>
            <td><code>{{ user.temp_pwrd or "—" }}</code></td>
            <td>
              <button class="btn btn-sm btn-outline-primary"
                      onclick="openEditModal('{{ user.email }}', '{{ user.role }}')"
                      {% if user.is_main_admin or (user.role == 'admin' and not session['is_main_admin']) %}disabled{% endif %}>
                Edit
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="edit-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="original_email" id="edit-original-email">
          <input type="hidden" name="original_role" id="edit-original-role">
          <div class="mb-3">
            <label>Email</label>
            <input type="email" class="form-control" name="new_email" id="edit-email" required>
          </div>
          <div class="mb-3">
            <label>Role</label>
            <select class="form-select" name="role" id="edit-role">
              <option value="admin">Admin</option>
              <option value="policymaker">Policymaker</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="admin-password-edit">Admin Password</label>
            <input type="password" class="form-control" name="admin_password" id="admin-password-edit" required placeholder="Enter admin password to confirm">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="password" id="admin-password" class="form-control" placeholder="Enter admin password">
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="confirm-delete">Confirm Delete</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // === DataTable Setup ===
  $('#user-table').DataTable({
    pageLength: 10,
    order: [],  // ← disables default sorting
    dom: "lfrtip",
    columnDefs: [
      { orderable: false, targets: [0, 4] }
    ]
  });

  // === Select All Checkbox ===
  document.getElementById("select-all").addEventListener("click", function () {
    document.querySelectorAll(".select-user").forEach(cb => cb.checked = this.checked);
  });

  // === Trigger Delete ===
  document.getElementById("trigger-delete").addEventListener("click", function () {
    const selected = document.querySelectorAll(".select-user:checked");
    if (selected.length === 0) return alert("Select users to delete");
    new bootstrap.Modal(document.getElementById("passwordModal")).show();
  });

  // === Confirm Deletion ===
  document.getElementById("confirm-delete").addEventListener("click", function () {
  const password = document.getElementById("admin-password").value.trim();
  const selected = [...document.querySelectorAll(".select-user:checked")];
  const emails = selected.map(cb => cb.value.split("||")[0]);
  const roles = selected.map(cb => cb.value.split("||")[1]);

  fetch("/delete_user", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ emails, roles, password })
  })
  .then(r => r.json())
  .then(data => {
    if (data.error) {
      alert("❌ " + data.error);
    } else {
      let msg = "";
      if (data.deleted && data.deleted.length > 0)
        msg += "✅ Deleted:\n- " + data.deleted.join("\n- ");
      if (data.skipped && data.skipped.length > 0)
        msg += "\n⚠️ Skipped:\n- " + data.skipped.join("\n- ");
      alert(msg.trim());
      const modal = bootstrap.Modal.getInstance(document.getElementById("passwordModal"));
      modal.hide();
      location.reload();
    }
  });
});

  // === Edit Modal ===
  window.openEditModal = function (email, role) {
    document.getElementById("edit-original-email").value = email;
    document.getElementById("edit-original-role").value = role;
    document.getElementById("edit-email").value = email;
    document.getElementById("edit-role").value = role;
    new bootstrap.Modal(document.getElementById("editModal")).show();
  };

  // === Edit Submit ===
  document.getElementById("edit-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const form = new FormData(this);
    form.append("admin_password", document.getElementById("admin-password-edit").value.trim());

    fetch("/update_user", {
      method: "POST",
      body: form
    }).then(r => r.json()).then(data => {
      if (data.success) {
        alert("✅ User updated");
        location.reload();
      } else {
        alert("❌ " + (data.error || "Update failed"));
      }
    });
  });
});
</script>
{% endblock %}
